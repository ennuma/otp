#TARG      := $(shell grep -h -v ^\# ../../../../server/erl/*/mirrors ../../../../server/setup/mirrors)
FOR       := for i in $(TARG); do
FORKDONE  :=& done; wait
DONE      :=; done
RSYNC     := rsync -t -C -r --exclude-from=/dev/stdin
IGNORE    := svn propget svn:ignore
U         ?= whatsapp
ROOT      ?= /home/$(U)

TMP	  := /tmp/wa-erts-install
ERL	  := /usr/local/lib/erlang
BIN	  := $(ERL)/erts-5.8.4/bin
VER	  := $(shell cat wa-version)
ERL_TOP	  := `pwd`
TARGET	  := x86_64-unknown-freebsd8.2

host-prep:
	ssh -t $(H) sudo ln $(BIN)/beam.smp $(BIN)/beam.smp.orig
	ssh -t $(H) sudo ln $(BIN)/erlexec $(BIN)/erlexec.orig

host-install:
	ssh $(H) mkdir -p /tmp/wa-erts-install
	scp -C bin/$(TARGET)/beam.smp bin/$(TARGET)/erlexec lib/kernel/ebin/inet_tcp_dist.beam lib/kernel/src/inet_tcp_dist.erl $(H):$(TMP)
	ssh -t $(H) sudo cp $(TMP)/beam.smp $(BIN)/beam.smp.$(VER)
	ssh -t $(H) sudo cp $(TMP)/erlexec $(BIN)/erlexec.$(VER)
	ssh -t $(H) sudo cp $(TMP)/inet_tcp_dist.beam $(ERL)/lib/kernel-2.14.4/ebin
	ssh -t $(H) sudo cp $(TMP)/inet_tcp_dist.erl $(ERL)/lib/kernel-2.14.4/src

host-enable:
	ssh -t $(H) sudo ln -sf $(BIN)/beam.smp.$(VER) $(BIN)/beam.smp
	ssh -t $(H) sudo ln -sf $(BIN)/erlexec.$(VER) $(BIN)/erlexec
